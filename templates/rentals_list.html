{% extends "base.html" %} {% block content %}
<h4 class="mb-3">Thu√™ / Tr·∫£ truy·ªán</h4>

<form
  class="d-flex gap-2 mb-3"
  method="get"
  action="{{ url_for('rentals_list') }}"
>
  <input
    class="form-control"
    name="q"
    placeholder="T√¨m theo t√™n truy·ªán / KH"
    value="{{ q or '' }}"
  />
  <button class="btn btn-dark">T√¨m</button>
  <!-- Quan tr·ªçng -->
  <button
    type="button"
    class="btn btn-success ms-auto"
    data-bs-toggle="modal"
    data-bs-target="#addModal"
  >
    T·∫°o giao d·ªãch thu√™ truy·ªán
  </button>
</form>

<!-- ============ B·∫¢NG CHO DESKTOP/TABLET ============ -->
<div class="table-wrap">
  <table class="table table-striped table-hover align-middle mb-0">
    <thead class="table-dark">
      <tr>
        <th>ID truy·ªán</th>
        <th>T√™n truy·ªán</th>
        <th>Kh√°ch h√†ng</th>
        <th>Ng√†y thu√™</th>
        <th>ƒê·∫øn h·∫°n</th>
        <th>Ng√†y tr·∫£</th>
        <th>Gi√° thu√™</th>
        <th>Ph√≠ tr·ªÖ</th>
        <th style="width: 160px"></th>
      </tr>
    </thead>
    <tbody>
      {% for r in rentals %}
      <tr>
        <td>{{ r.manga_id }}</td>
        <td>{{ r.manga_title }}</td>
        <td>{{ r.customer_name }}</td>
        <td>{{ r.created_at }}</td>
        <td>{{ r.due_at }}</td>
        <td>{{ r.returned_at or 'Ch∆∞a tr·∫£' }}</td>
        <td>{{ r.rent_price }}</td>
        <td>{{ r.late_fee }}</td>
        <td class="text-end">
          {% if not r.returned_at %}
          <form
            method="post"
            action="{{ url_for('rentals_return', rid=r.id) }}"
            style="display: inline"
          >
            <button class="btn btn-sm btn-primary">Tr·∫£ truy·ªán</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ============ TH·∫∫ CHO MOBILE ============ -->
<div class="list-cards">
  {% for r in rentals %}
  <div class="list-card">
    <div class="list-row">
      <span class="list-label">ID truy·ªán</span><span>{{ r.manga_id }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">T√™n truy·ªán</span><span>{{ r.manga_title }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Kh√°ch h√†ng</span
      ><span>{{ r.customer_name }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Ng√†y thu√™</span><span>{{ r.created_at }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">ƒê·∫øn h·∫°n</span><span>{{ r.due_at }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Ng√†y tr·∫£</span
      ><span>{{ r.returned_at or 'Ch∆∞a tr·∫£' }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Gi√° thu√™</span><span>{{ r.rent_price }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Ph√≠ tr·ªÖ</span><span>{{ r.late_fee }}</span>
    </div>
    {% if not r.returned_at %}
    <div class="list-actions">
      <form method="post" action="{{ url_for('rentals_return', rid=r.id) }}">
        <button class="btn btn-sm btn-outline-primary w-100">Tr·∫£ truy·ªán</button>
      </form>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<!-- Modal t·∫°o giao d·ªãch -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <form
      class="modal-content"
      method="post"
      action="{{ url_for('rentals_create') }}"
    >
      <div class="modal-header">
        <h5 class="modal-title">T·∫°o giao d·ªãch thu√™</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Ch·ªçn kh√°ch h√†ng (nh·∫≠p ID ho·∫∑c ch·ªçn)</label>
          <input
            name="customer_id"
            class="form-control"
            list="lstCus"
            placeholder="ID kh√°ch h√†ng"
            required
          />
          <datalist id="lstCus">
            {% set customers =
            read_json(user_file(session['username'],'customers.json'), []) %} {%
            for c in customers %}
            <option value="{{ c.id }}">{{ c.name }} - {{ c.phone }}</option>
            {% endfor %}
          </datalist>
        </div>
        <div class="mb-2">
          <label class="form-label">Ch·ªçn truy·ªán (nh·∫≠p ID ho·∫∑c ch·ªçn)</label>
          <div class="input-group">
            <input
              id="manga_id_input"
              name="manga_id"
              class="form-control"
              list="lstManga"
              placeholder="ID truy·ªán"
              required
            />
            <button
              type="button"
              class="btn btn-outline-secondary"
              id="btnScanRentalManga"
              title="Qu√©t m√£ v·∫°ch ƒë·ªÉ ch·ªçn truy·ªán"
            >
              üì∑
            </button>
          </div>
          <datalist id="lstManga">
            {% set manga =
            read_json(user_file(session['username'],'manga.json'), []) %} {% for
            m in manga %}
            <option value="{{ m.id }}">
              {{ m.title }} ({{ m.rent_price }} VND) ‚Äî t·ªìn: {{ m.stock }}
            </option>
            {% endfor %}
          </datalist>
        </div>
        <div class="mb-2">
          <label class="form-label">Gi√° thu√™</label>
          <input
            id="rent_price_input"
            name="rent_price"
            class="form-control"
            placeholder="v√≠ d·ª• 10.000"
            required
          />
          <div class="form-text">
            Gi√° thu√™ s·∫Ω ƒëi·ªÅn theo truy·ªán ƒë√£ ch·ªçn (b·∫°n c√≥ th·ªÉ s·ª≠a tr∆∞·ªõc khi l∆∞u).
          </div>
        </div>
        <div class="alert alert-secondary">
          Ng√†y thu√™ t·ª± ƒë·ªông: {{ now() }}<br />
          Ng√†y ƒë·∫øn h·∫°n: +{{ shop_cfg.default_rent_days }} ng√†y sau khi t·∫°o.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          H·ªßy</button
        ><button class="btn btn-success">T·∫°o giao d·ªãch</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal qu√©t m√£ v·∫°ch ƒë·ªÉ ch·ªçn truy·ªán khi t·∫°o giao d·ªãch -->
<div class="modal fade" id="barcodeScanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Qu√©t m√£ v·∫°ch</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div id="barcode-reader" style="width: 100%"></div>
        <p class="small text-muted mt-2 mb-0">
          Cho ph√©p truy c·∫≠p camera, r·ªìi ƒë∆∞a m√£ v·∫°ch/QR sau cu·ªën truy·ªán v√†o
          khung.
        </p>
      </div>
    </div>
  </div>
</div>

<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    const mangaInput = document.getElementById("manga_id_input");
    const priceInput = document.getElementById("rent_price_input");
    const scanModalEl = document.getElementById("barcodeScanModal");
    const btnScanRentalManga = document.getElementById("btnScanRentalManga");

    // --- Gi·ªØ ch·ª©c nƒÉng c≈©: t·ª± ƒëi·ªÅn gi√° thu√™ theo ID truy·ªán ---
    if (mangaInput && priceInput) {
      mangaInput.addEventListener("change", function () {
        const id = mangaInput.value.trim();
        if (!id) return;

        fetch(`/api/manga-price?manga_id=${encodeURIComponent(id)}`)
          .then((res) => res.json())
          .then((data) => {
            if (data.ok && data.price) {
              // ƒêi·ªÅn gi√° thu√™ ƒë√∫ng theo truy·ªán ƒë√£ ch·ªçn
              priceInput.value = data.price;
            }
          })
          .catch((err) => {
            console.error("L·ªói l·∫•y gi√° thu√™:", err);
          });
      });
    }

    // --- Qu√©t m√£ v·∫°ch ƒë·ªÉ t·ª± ch·ªçn truy·ªán + gi√° thu√™ ---
    let html5QrCode = null;

    function startScanner() {
      const readerEl = document.getElementById("barcode-reader");
      if (!readerEl) return;
      readerEl.innerHTML = "";

      html5QrCode = new Html5Qrcode("barcode-reader");

      html5QrCode
        .start(
          { facingMode: "environment" }, // ∆∞u ti√™n cam sau
          { fps: 10, qrbox: 250 }, // khung qu√©t
          onScanSuccess,
          function (err) {
            /* b·ªè qua l·ªói t·ª´ng frame */
          }
        )
        .catch((err) => {
          console.error("Kh√¥ng m·ªü ƒë∆∞·ª£c camera:", err);
        });
    }

    function stopScanner() {
      if (!html5QrCode) return;
      html5QrCode
        .stop()
        .then(() => html5QrCode.clear())
        .catch(() => {})
        .finally(() => {
          html5QrCode = null;
        });
    }

    function onScanSuccess(decodedText, decodedResult) {
      // G·ªçi API l·∫•y truy·ªán theo m√£ v·∫°ch ƒë√£ qu√©t
      fetch(
        `/api/manga-from-barcode?barcode=${encodeURIComponent(decodedText)}`
      )
        .then((res) => res.json())
        .then((data) => {
          if (!data.ok) {
            alert("Kh√¥ng t√¨m th·∫•y truy·ªán c√≥ m√£ v·∫°ch n√†y.");
            return;
          }
          if (mangaInput) mangaInput.value = data.id || "";
          if (priceInput && data.price) priceInput.value = data.price;
        })
        .catch((err) => {
          console.error("L·ªói l·∫•y truy·ªán theo m√£ v·∫°ch:", err);
        })
        .finally(() => {
          const modal = bootstrap.Modal.getInstance(scanModalEl);
          if (modal) modal.hide();
        });
    }

    if (scanModalEl) {
      scanModalEl.addEventListener("shown.bs.modal", function () {
        startScanner();
      });

      scanModalEl.addEventListener("hidden.bs.modal", function () {
        stopScanner();
      });
    }

    if (btnScanRentalManga && scanModalEl) {
      btnScanRentalManga.addEventListener("click", function () {
        const modal = new bootstrap.Modal(scanModalEl);
        modal.show();
      });
    }
  });
</script>
{% endblock %}
