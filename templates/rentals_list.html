{% extends "base.html" %} {% block content %}
<h4 class="mb-3">Thuê / Trả truyện</h4>

<form
  class="d-flex gap-2 mb-3"
  method="get"
  action="{{ url_for('rentals_list') }}"
>
  <input
    class="form-control"
    name="q"
    placeholder="Tìm theo tên truyện / KH"
    value="{{ q or '' }}"
  />
  <button class="btn btn-dark">Tìm</button>
  <!-- Quan trọng -->
  <button
    type="button"
    class="btn btn-success ms-auto"
    data-bs-toggle="modal"
    data-bs-target="#addModal"
  >
    Tạo giao dịch thuê truyện
  </button>
</form>

<!-- ============ BẢNG CHO DESKTOP/TABLET ============ -->
<div class="table-wrap">
  <table class="table table-striped table-hover align-middle mb-0">
    <thead class="table-dark">
      <tr>
        <th>ID truyện</th>
        <th>Tên truyện</th>
        <th>Khách hàng</th>
        <th>Ngày thuê</th>
        <th>Đến hạn</th>
        <th>Ngày trả</th>
        <th>Giá thuê</th>
        <th>Phí trễ</th>
        <th style="width: 160px"></th>
      </tr>
    </thead>
    <tbody>
      {% for r in rentals %}
      <tr>
        <td>{{ r.manga_id }}</td>
        <td>{{ r.manga_title }}</td>
        <td>{{ r.customer_name }}</td>
        <td>{{ r.created_at }}</td>
        <td>{{ r.due_at }}</td>
        <td>{{ r.returned_at or 'Chưa trả' }}</td>
        <td>{{ r.rent_price }}</td>
        <td>{{ r.late_fee }}</td>
        <td class="text-end">
          {% if not r.returned_at %}
          <form
            method="post"
            action="{{ url_for('rentals_return', rid=r.id) }}"
            style="display: inline"
          >
            <button class="btn btn-sm btn-primary">Trả truyện</button>
          </form>
          {% endif %}
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ============ THẺ CHO MOBILE ============ -->
<div class="list-cards">
  {% for r in rentals %}
  <div class="list-card">
    <div class="list-row">
      <span class="list-label">ID truyện</span><span>{{ r.manga_id }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Tên truyện</span><span>{{ r.manga_title }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Khách hàng</span
      ><span>{{ r.customer_name }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Ngày thuê</span><span>{{ r.created_at }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Đến hạn</span><span>{{ r.due_at }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Ngày trả</span
      ><span>{{ r.returned_at or 'Chưa trả' }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Giá thuê</span><span>{{ r.rent_price }}</span>
    </div>
    <div class="list-row">
      <span class="list-label">Phí trễ</span><span>{{ r.late_fee }}</span>
    </div>
    {% if not r.returned_at %}
    <div class="list-actions">
      <form method="post" action="{{ url_for('rentals_return', rid=r.id) }}">
        <button class="btn btn-sm btn-outline-primary w-100">Trả truyện</button>
      </form>
    </div>
    {% endif %}
  </div>
  {% endfor %}
</div>

<!-- Modal tạo giao dịch -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <form
      class="modal-content"
      method="post"
      action="{{ url_for('rentals_create') }}"
    >
      <div class="modal-header">
        <h5 class="modal-title">Tạo giao dịch thuê</h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
        ></button>
      </div>
      <div class="modal-body">
        <div class="mb-2">
          <label class="form-label">Chọn khách hàng (nhập ID hoặc chọn)</label>
          <input
            name="customer_id"
            class="form-control"
            list="lstCus"
            placeholder="ID khách hàng"
            required
          />
          <datalist id="lstCus">
            {% set customers =
            read_json(user_file(session['username'],'customers.json'), []) %} {%
            for c in customers %}
            <option value="{{ c.id }}">{{ c.name }} - {{ c.phone }}</option>
            {% endfor %}
          </datalist>
        </div>
        <div class="mb-2">
          <label class="form-label">Chọn truyện (nhập ID hoặc chọn)</label>
          <input
            name="manga_id"
            class="form-control"
            list="lstManga"
            placeholder="ID truyện"
            required
          />
          <datalist id="lstManga">
            {% set manga =
            read_json(user_file(session['username'],'manga.json'), []) %} {% for
            m in manga %}
            <option value="{{ m.id }}">
              {{ m.title }} ({{ m.rent_price }} VND) — tồn: {{ m.stock }}
            </option>
            {% endfor %}
          </datalist>
        </div>
        <div class="mb-2">
          <label class="form-label">Giá thuê</label>
          <input
            name="rent_price"
            class="form-control"
            placeholder="ví dụ 10.000"
            required
          />
          <div class="form-text">
            Giá thuê sẽ điền theo truyện đã chọn (bạn có thể sửa trước khi lưu).
          </div>
        </div>
        <div class="alert alert-secondary">
          Ngày thuê tự động: {{ now() }}<br />
          Ngày đến hạn: +5 ngày sau khi tạo.
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          Hủy</button
        ><button class="btn btn-success">Tạo giao dịch</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}
