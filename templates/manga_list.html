{% extends "base.html" %}
{% block content %}
<h4 class="mb-3">Quáº£n lÃ½ truyá»‡n</h4>

<form class="d-flex gap-2 mb-3" method="get" action="{{ url_for('manga_list') }}">
  <input
    class="form-control"
    name="q"
    placeholder="TÃ¬m theo tÃªn / tÃ¡c giáº£ / thá»ƒ loáº¡i / mÃ£ váº¡ch"
    value="{{ q or '' }}"
  >
  <button class="btn btn-dark" type="submit">TÃ¬m</button>

  <!-- NÃºt quÃ©t mÃ£ váº¡ch Ä‘á»ƒ tÃ¬m truyá»‡n -->
  <button
    type="button"
    class="btn btn-outline-secondary"
    id="btnScanSearch"
    title="QuÃ©t mÃ£ váº¡ch Ä‘á»ƒ tÃ¬m truyá»‡n"
  >
    ðŸ“·
  </button>

  <button
    type="button"
    class="btn btn-success ms-auto"
    data-bs-toggle="modal"
    data-bs-target="#addModal"
  >
    ThÃªm truyá»‡n
  </button>
</form>

<!-- ============ Báº¢NG CHO DESKTOP/TABLET ============ -->
<div class="table-wrap">
  <table class="table table-striped table-hover align-middle mb-0">
    <thead class="table-dark">
      <tr>
        <th>ID truyá»‡n</th>
        <th>TÃªn truyá»‡n</th>
        <th>Thá»ƒ loáº¡i</th>
        <th>TÃ¡c giáº£</th>
        <th>GiÃ¡ thuÃª (VND)</th>
        <th>TÃ¬nh tráº¡ng</th>
        <th>Tá»“n kho</th>
        <th style="width:160px"></th>
      </tr>
    </thead>
    <tbody>
      {% for m in items %}
      <tr>
        <td>{{ m.id }}</td>
        <td>{{ m.title }}</td>
        <td>{{ m.genre }}</td>
        <td>{{ m.author }}</td>
        <td>{{ m.rent_price }}</td>
        <td>{{ m.condition }}</td>
        <td>{{ m.stock }}</td>
        <td class="text-end">
          <button type="button" class="btn btn-sm btn-primary" data-bs-toggle="modal" data-bs-target="#editModal{{m.id}}">Sá»­a</button>
          <form method="post" action="{{ url_for('manga_delete', mid=m.id) }}" style="display:inline" onsubmit="return confirm('XÃ³a truyá»‡n nÃ y?')">
            <button class="btn btn-sm btn-danger">XÃ³a</button>
          </form>
        </td>
      </tr>
      {% endfor %}
    </tbody>
  </table>
</div>

<!-- ============ DANH SÃCH THáºº CHO MOBILE ============ -->
<div class="list-cards">
  {% for m in items %}
  <div class="list-card">
    <div class="list-row"><span class="list-label">ID</span><span>{{ m.id }}</span></div>
    <div class="list-row"><span class="list-label">TÃªn truyá»‡n</span><span>{{ m.title }}</span></div>
    <div class="list-row"><span class="list-label">Thá»ƒ loáº¡i</span><span>{{ m.genre }}</span></div>
    <div class="list-row"><span class="list-label">TÃ¡c giáº£</span><span>{{ m.author }}</span></div>
    <div class="list-row"><span class="list-label">GiÃ¡ thuÃª</span><span>{{ m.rent_price }} VND</span></div>
    <div class="list-row"><span class="list-label">TÃ¬nh tráº¡ng</span><span>{{ m.condition }}</span></div>
    <div class="list-row"><span class="list-label">Tá»“n kho</span><span>{{ m.stock }}</span></div>
    <div class="list-actions">
      <button type="button" class="btn btn-sm btn-outline-primary" data-bs-toggle="modal" data-bs-target="#editModal{{m.id}}">Sá»­a</button>
      <form method="post" action="{{ url_for('manga_delete', mid=m.id) }}" style="display:inline" onsubmit="return confirm('XÃ³a truyá»‡n nÃ y?')">
        <button class="btn btn-sm btn-outline-danger">XÃ³a</button>
      </form>
    </div>
  </div>
  {% endfor %}
</div>


<!-- ===== Modals Sá»¬A: Ä‘áº·t ngoÃ i báº£ng ===== -->
{% for m in items %}
<div class="modal fade" id="editModal{{m.id}}" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('manga_update', mid=m.id) }}">
      <div class="modal-header">
        <h5 class="modal-title">Sá»­a truyá»‡n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-2">
        <div class="col-12">
          <label class="form-label">TÃªn truyá»‡n</label>
          <input name="title" class="form-control" value="{{m.title}}" required>
        </div>
        <div class="col-6">
          <label class="form-label">Thá»ƒ loáº¡i</label>
          <input name="genre" class="form-control" value="{{m.genre}}" required>
        </div>
        <div class="col-6">
          <label class="form-label">TÃ¡c giáº£</label>
          <input name="author" class="form-control" value="{{m.author}}" required>
        </div>
        <div class="col-6">
          <label class="form-label">GiÃ¡ thuÃª (VND)</label>
          <input name="rent_price" class="form-control" value="{{m.rent_price}}" required>
        </div>
        <div class="col-6">
          <label class="form-label">TÃ¬nh tráº¡ng</label>
          <select name="condition" class="form-select">
            <option {{'selected' if m.condition=='Má»›i' else ''}}>Má»›i</option>
            <option {{'selected' if m.condition=='CÅ©' else ''}}>CÅ©</option>
          </select>
        </div>
                <div class="col-6">
          <label class="form-label">Sá»‘ lÆ°á»£ng tá»“n kho</label>
          <input
            name="stock"
            type="number"
            class="form-control"
            value="{{ m.stock }}"
            required
          >
        </div>

        <!-- Ã” mÃ£ váº¡ch + nÃºt quÃ©t trong modal Sá»­a -->
        <div class="col-6">
          <label class="form-label">MÃ£ váº¡ch</label>
          <div class="input-group">
            <input
              name="barcode"
              type="text"
              class="form-control"
              value="{{ m.barcode or '' }}"
              placeholder="QuÃ©t hoáº·c nháº­p mÃ£ váº¡ch"
            >
            <button
              type="button"
              class="btn btn-outline-secondary btn-scan-barcode"
              title="QuÃ©t mÃ£ váº¡ch cho truyá»‡n nÃ y"
            >
              ðŸ“·
            </button>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Há»§y</button>
        <button class="btn btn-primary">LÆ°u</button>
      </div>
    </form>
  </div>
</div>
{% endfor %}

<!-- Modal THÃŠM -->
<div class="modal fade" id="addModal" tabindex="-1">
  <div class="modal-dialog">
    <form class="modal-content" method="post" action="{{ url_for('manga_add') }}">
      <div class="modal-header">
        <h5 class="modal-title">ThÃªm truyá»‡n</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body row g-2">
        <div class="col-6"><label class="form-label">ID truyá»‡n</label><input name="id" class="form-control" required></div>
        <div class="col-6"><label class="form-label">TÃªn truyá»‡n</label><input name="title" class="form-control" required></div>
        <div class="col-6"><label class="form-label">Thá»ƒ loáº¡i</label><input name="genre" class="form-control" required></div>
        <div class="col-6"><label class="form-label">TÃ¡c giáº£</label><input name="author" class="form-control" required></div>
        <div class="col-6"><label class="form-label">GiÃ¡ thuÃª (VND)</label><input name="rent_price" class="form-control" required></div>
                <div class="col-6">
          <label class="form-label">TÃ¬nh tráº¡ng</label>
          <select name="condition" class="form-select">
            <option>Má»›i</option>
            <option>CÅ©</option>
          </select>
        </div>

        <div class="col-6">
          <label class="form-label">Sá»‘ lÆ°á»£ng tá»“n kho</label>
          <input
            name="stock"
            type="number"
            class="form-control"
            required
          >
        </div>

        <!-- Ã” mÃ£ váº¡ch + nÃºt quÃ©t trong modal ThÃªm -->
        <div class="col-6">
          <label class="form-label">MÃ£ váº¡ch</label>
          <div class="input-group">
            <input
              name="barcode"
              type="text"
              class="form-control"
              placeholder="QuÃ©t hoáº·c nháº­p mÃ£ váº¡ch"
            >
            <button
              type="button"
              class="btn btn-outline-secondary btn-scan-barcode"
              title="QuÃ©t mÃ£ váº¡ch cho truyá»‡n nÃ y"
            >
              ðŸ“·
            </button>
          </div>
        </div>
      </div>
            <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Há»§y</button>
        <button class="btn btn-success">LÆ°u</button>
      </div>
    </form>
  </div>
</div>

<!-- Modal dÃ¹ng chung Ä‘á»ƒ má»Ÿ camera quÃ©t mÃ£ váº¡ch -->
<div class="modal fade" id="barcodeScanModal" tabindex="-1">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">QuÃ©t mÃ£ váº¡ch</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <div id="barcode-reader" style="width:100%;"></div>
        <p class="small text-muted mt-2 mb-0">
          Cho phÃ©p truy cáº­p camera, rá»“i Ä‘Æ°a mÃ£ váº¡ch/QR sau cuá»‘n truyá»‡n vÃ o khung.
        </p>
      </div>
    </div>
  </div>
</div>

<!-- ThÆ° viá»‡n quÃ©t mÃ£ vÃ  code Ä‘iá»u khiá»ƒn -->
<script src="https://unpkg.com/html5-qrcode" type="text/javascript"></script>
<script>
  let html5QrCode = null;
  let barcodeMode = null;      // 'search' hoáº·c 'input'
  let barcodeInputEl = null;   // Input hiá»‡n táº¡i cáº§n Ä‘iá»n mÃ£ váº¡ch

  function startBarcodeScanner() {
    const readerEl = document.getElementById("barcode-reader");
    if (!readerEl) return;

    // XÃ³a ná»™i dung cÅ© trong khung, phÃ²ng trÆ°á»ng há»£p láº§n trÆ°á»›c cÃ²n sÃ³t DOM
    readerEl.innerHTML = "";

    // Má»—i láº§n má»Ÿ modal sáº½ táº¡o 1 instance má»›i
    html5QrCode = new Html5Qrcode("barcode-reader");

    html5QrCode
      .start(
        { facingMode: "environment" },   // Æ°u tiÃªn camera sau
        { fps: 10, qrbox: 250 },         // cáº¥u hÃ¬nh khung
        onScanSuccess,
        onScanError
      )
      .catch(err => {
        console.error("KhÃ´ng má»Ÿ Ä‘Æ°á»£c camera:", err);
      });
  }

  function onScanSuccess(decodedText, decodedResult) {
    // Khi quÃ©t Ä‘Æ°á»£c mÃ£
    if (barcodeMode === "input" && barcodeInputEl) {
      // Äá»• mÃ£ vÃ o Ã´ input (ThÃªm/Sá»­a truyá»‡n)
      barcodeInputEl.value = decodedText;
    }

    if (barcodeMode === "search") {
      // Äá»• mÃ£ vÃ o Ã´ tÃ¬m kiáº¿m vÃ  submit form
      const qInput = document.querySelector('form[method="get"] input[name="q"]');
      if (qInput) {
        qInput.value = decodedText;
        qInput.form.submit();
      }
    }

    // Táº¯t camera + Ä‘Ã³ng modal sau khi quÃ©t xong
    closeScannerAndHideModal();
  }

  function onScanError(errorMessage) {
    // Lá»—i tá»«ng frame thÃ¬ bá» qua, khÃ´ng cáº§n log cho Ä‘á»¡ spam console
    // console.log(errorMessage);
  }

  function closeScannerAndHideModal() {
    const modalEl = document.getElementById("barcodeScanModal");
    const modal = bootstrap.Modal.getInstance(modalEl);

    if (!html5QrCode) {
      if (modal) modal.hide();
      return;
    }

    html5QrCode
      .stop()
      .then(() => html5QrCode.clear())
      .then(() => {
        html5QrCode = null;
        if (modal) modal.hide();
      })
      .catch(err => {
        console.error("KhÃ´ng táº¯t Ä‘Æ°á»£c camera:", err);
        html5QrCode = null;
        if (modal) modal.hide();
      });
  }

  // Náº¿u user tá»± áº¥n nÃºt X Ä‘Ã³ng modal thÃ¬ cÅ©ng táº¯t camera
  function forceStopScannerOnHide() {
    if (!html5QrCode) return;

    html5QrCode
      .stop()
      .then(() => html5QrCode.clear())
      .catch(() => {})
      .finally(() => {
        html5QrCode = null;
      });
  }

  document.addEventListener("DOMContentLoaded", function () {
    const scanModalEl = document.getElementById("barcodeScanModal");

    // Khi modal hiá»ƒn thá»‹ thÃ¬ báº­t camera
    scanModalEl.addEventListener("shown.bs.modal", function () {
      startBarcodeScanner();
    });

    // Khi modal Ä‘Ã³ng (user áº¥n X hoáº·c click ra ngoÃ i) thÃ¬ Ä‘áº£m báº£o táº¯t camera
    scanModalEl.addEventListener("hidden.bs.modal", function () {
      forceStopScannerOnHide();
    });

    // NÃºt quÃ©t mÃ£ á»Ÿ cáº¡nh Ã´ TÃ¬m
    const btnScanSearch = document.getElementById("btnScanSearch");
    if (btnScanSearch) {
      btnScanSearch.addEventListener("click", function () {
        barcodeMode = "search";
        barcodeInputEl = null;
        const modal = new bootstrap.Modal(scanModalEl);
        modal.show();
      });
    }

    // CÃ¡c nÃºt quÃ©t mÃ£ trong modal ThÃªm / Sá»­a truyá»‡n
    document.querySelectorAll(".btn-scan-barcode").forEach(function (btn) {
      btn.addEventListener("click", function () {
        const group = this.closest(".input-group");
        const input = group ? group.querySelector('input[name="barcode"]') : null;
        barcodeMode = "input";
        barcodeInputEl = input;
        const modal = new bootstrap.Modal(scanModalEl);
        modal.show();
      });
    });
  });
</script>
{% endblock %}
