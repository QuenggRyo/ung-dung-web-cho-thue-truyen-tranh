{% extends "base.html" %} {% block content %}
<h4 class="mb-3">Thông báo</h4>
<div class="d-flex justify-content-between align-items-center mb-3">
  <p class="text-muted mb-0">
    Double-click vào thông báo để đánh dấu đã đọc từng cái.
  </p>

  <div class="d-flex gap-2">
    <button
      type="button"
      class="btn btn-sm btn-outline-primary"
      onclick="markAllRead()"
    >
      Đánh dấu tất cả đã đọc
    </button>

    <button
      type="button"
      class="btn btn-sm btn-outline-danger"
      onclick="deleteAllNoti()"
    >
      Xóa tất cả thông báo
    </button>
  </div>
</div>

<div class="list-y-scroll mt-2">
  <ul class="list-group mb-0">
    {% for n in notifs %}
    <li
      class="list-group-item d-flex justify-content-between align-items-center {% if not n.read %}list-group-item-warning{% endif %}"
      ondblclick="markRead('{{ n.id }}', this)"
    >
      <div>
        <div class="fw-semibold">{{ n.message }}</div>
        <div class="small text-muted">{{ n.created_at }}</div>
      </div>
      {% if not n.read %}<span class="badge bg-danger rounded-pill">Mới</span>{%
      endif %}
    </li>
    {% endfor %}
  </ul>
</div>

<script>
  function markRead(id, el) {
    fetch("{{ url_for('notifications') }}?read=" + id, { method: "POST" })
      .then(() => {
        // Xóa trạng thái "chưa đọc" trên item
        el.classList.remove("list-group-item-warning");
        el.querySelector(".badge")?.remove();

        // --- Cập nhật ngay số thông báo trên menu ---
        const badge = document.querySelector(".badge-noti .count");
        if (badge) {
          let current = parseInt(badge.textContent.trim());
          if (!isNaN(current) && current > 0) {
            current -= 1;
            if (current <= 0) {
              badge.remove(); // hết thì ẩn luôn
            } else {
              badge.textContent = current; // cập nhật số mới
            }
          }
        }
      })
      .catch(() => {});
  }

  // ===== Đánh dấu TẤT CẢ thông báo là đã đọc =====
  function markAllRead() {
    fetch("{{ url_for('notifications') }}?read=all", { method: "POST" })
      .then(() => {
        // Xóa trạng thái "chưa đọc" trên toàn bộ danh sách
        document.querySelectorAll(".list-group-item-warning").forEach((li) => {
          li.classList.remove("list-group-item-warning");
          li.querySelector(".badge")?.remove();
        });

        // Xóa badge số thông báo trên menu
        const badge = document.querySelector(".badge-noti .count");
        if (badge) {
          badge.remove();
        }
      })
      .catch(() => {});
  }

  // ===== XÓA TẤT CẢ THÔNG BÁO =====
  function deleteAllNoti() {
    if (
      !confirm(
        "Bạn có chắc muốn xóa TẤT CẢ thông báo? Hành động này không thể hoàn tác."
      )
    ) {
      return;
    }

    fetch("{{ url_for('notifications') }}?delete=all", { method: "POST" })
      .then(() => {
        // Xóa toàn bộ item trong danh sách
        const ul = document.querySelector(".list-group");
        if (ul) {
          ul.innerHTML = "";
        }

        // Xóa badge số thông báo trên menu
        const badge = document.querySelector(".badge-noti .count");
        if (badge) {
          badge.remove();
        }
      })
      .catch(() => {});
  }
</script>

{% endblock %}
